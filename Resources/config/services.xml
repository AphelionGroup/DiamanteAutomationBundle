<?xml version="1.0" ?>
<!--

    Copyright (c) 2014 Eltrino LLC (http://eltrino.com)

    Licensed under the Open Software License (OSL 3.0).
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

       http://opensource.org/licenses/osl-3.0.php

    If you did not receive a copy of the license and are unable to
    obtain it through the world-wide-web, please send an email
    to license@eltrino.com so we can send you a copy immediately.

-->
<container xmlns="http://symfony.com/schema/dic/services"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services/services-1.0.xsd">

    <parameters>
        <parameter key="diamante.user.entity.class">Diamante\DeskBundle\Entity\DiamanteUser</parameter>
        <parameter key="diamante.user_factory.class">Diamante\DeskBundle\Model\User\DiamanteUserFactory</parameter>
        <parameter key="diamante.user.service.class">Diamante\DeskBundle\Infrastructure\Shared\Adapter\DiamanteUserService</parameter>
        <parameter key="diamante.contact.service.class">Diamante\DeskBundle\Infrastructure\Shared\Adapter\DiamanteContactService</parameter>
        <parameter key="diamante.command_factory.class">Diamante\DeskBundle\Form\CommandFactory</parameter>
        <!-- repositories start -->
        <parameter key="diamante.generic.repository.class">Diamante\DeskBundle\Infrastructure\Persistence\DoctrineGenericRepository</parameter>
        <!-- repositories end -->
        <parameter key="diamante.email_processing.form.type.default_branch.class">Diamante\DeskBundle\Form\Type\DefaultBranchType</parameter>
        <parameter key="diamante.email_processing.branchRemoveEventListener.class">Diamante\DeskBundle\Infrastructure\Branch\BranchRemoveEventListener</parameter>
        <parameter key="diamante.email_processing.placeholder.filter.default_branch.class">Diamante\DeskBundle\Placeholder\DefaultBranchFilter</parameter>
        <parameter key="diamante.user.details.service.class">Diamante\DeskBundle\Model\User\UserDetailsServiceImpl</parameter>
        <parameter key="diamante.autocomplete.user.search_handler.class">Diamante\DeskBundle\Search\DiamanteUserSearchHandler</parameter>
        <parameter key="diamante.user.details.twig.extension.class">Diamante\DeskBundle\Twig\Extensions\UserDetailsExtension</parameter>
    </parameters>

    <services>

        <service id="diamante.user.repository" class="%diamante.generic.repository.class%"
                 factory-service = "doctrine.orm.entity_manager"
                 factory-method  = "getRepository">
            <argument type="string">%diamante.user.entity.class%</argument>
        </service>

        <service id="diamante.user_factory" class="%diamante.user_factory.class%">
            <argument type="string">%diamante.user.entity.class%</argument>
        </service>

        <service id="diamante.user.service" class="%diamante.user.service.class%">
            <argument type="service" id="oro_user.manager"/>
            <argument type="service" id="diamante.user.repository"/>
        </service>

        <service id="diamante.contact.service" class="%diamante.contact.service.class%">
            <argument type="service" id="orocrm_contact.email.owner.provider"/>
            <argument type="service" id="doctrine.orm.entity_manager"/>
        </service>

        <service id="diamante.user.details.service" class="%diamante.user.details.service.class%">
            <argument type="service" id="diamante.user.service"/>
        </service>

        <service id="diamante.datagrid.extension.formatter.assignee_property" class="Diamante\DeskBundle\Datagrid\AssigneePropertyFormatter">
            <argument type="service" id="translator"/>
            <tag name="oro_datagrid.extension.formatter.property" type="assignee"/>
        </service>

        <service id="diamante_ticket.event_listener.ticket_attachments_view_listener" class="%oro_datagrid.event_listener.base_orm_relation.class%">
            <argument type="string">ticket</argument>
            <argument type="constant">false</argument>
            <tag name="kernel.event_listener" event="oro_datagrid.datagrid.build.after.diamante-ticket-attachments-grid" method="onBuildAfter"/>
        </service>

        <service id="diamante.command_factory" class="%diamante.command_factory.class%"/>

        <service id="diamante.email_processing.form.type.default_branch" class="%diamante.email_processing.form.type.default_branch.class%">
            <argument type="service" id="diamante.branch.service"/>
            <tag name="form.type" alias="diamante_email_processing_default_branch"/>
        </service>

        <service id="diamante.email_processing.branchRemoveEventListener" class="%diamante.email_processing.branchRemoveEventListener.class%">
            <argument type="service" id="service_container"/>
            <tag name="doctrine.event_listener" event="preRemove"></tag>
        </service>

        <service id="diamante.email_processing.placeholder.filter.default_branch" class="%diamante.email_processing.placeholder.filter.default_branch.class%">
            <argument type="service" id="diamante.email_processing.mail_system_settings"/>
            <tag name="oro_ui_placeholder.filter"/>
        </service>

        <service id="diamante.autocomplete.user.search_handler" class="%diamante.autocomplete.user.search_handler.class%">
            <argument type="string">Diamante\DeskBundle\Model\User\UserDetails</argument>
            <argument type="service" id="diamante.user.details.service"/>
            <argument type="service" id="diamante.user.repository"/>
            <argument type="service" id="oro_user.autocomplete.user.search_handler"/>
            <argument type="collection">
                <argument type="string">email</argument>
                <argument type="string">firstName</argument>
                <argument type="string">lastName</argument>
                <argument type="string">fullName</argument>
                <argument type="string">username</argument>
                <argument type="string">type</argument>
            </argument>
            <tag name="oro_form.autocomplete.search_handler" alias="diamante_user" acl_resource="oro_user_user_view"/>
        </service>

        <service id="diamante.user.details.twig.extension" class="%diamante.user.details.twig.extension.class%">
            <argument type="service" id="diamante.user.details.service"/>
            <argument type="service" id="diamante.user.service"/>
            <tag name="twig.extension"/>
        </service>
    </services>
</container>
